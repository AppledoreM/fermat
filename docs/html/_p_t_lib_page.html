<!-- HTML header for doxygen 1.8.4-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<title>Fermat: PTLib</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date(); a = s.createElement(o),
  m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-47310325-1', 'nvlabs.github.io');
    ga('send', 'pageview');
</script>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Fermat
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">PTLib </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Top: <a class="el" href="_overture_contents_page.html">Contents</a></p>
<p><a class="el" href="group___p_t_lib.html">PTLib</a> is a flexible path tracing library, thought to be as performant as possible and yet vastly configurable at compile-time. The module is organized into a host library of parallel kernels, <a class="el" href="group___p_t_lib.html">PTLib</a>, and a core module of device-side functions, <a class="el" href="group___p_t_lib_core.html">PTLibCore</a>. The latter provides functions to generate primary rays, process path vertices, sample Next-Event Estimation and emissive surface hits at each of them, and process all the generated samples. In order to make the whole process configurable, all the functions accept three template interfaces: </p><dl class="section user"><dt></dt><dd><a class="anchor" id="TPTContext"></a><ol type="1">
<li>a context interface, holding members describing the current path tracer state, and providing two trace methods, for scattering and shadow rays respectively. The basic path tracer state can be inherited from the <a class="el" href="struct_p_t_context_base.html">PTContextBase</a> class. On top of that, this class has to provide the following interface: <br />
<div class="fragment"><div class="line"><span class="keyword">struct </span>TPTContext</div><div class="line">{</div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> trace_ray(</div><div class="line">      TPTVertexProcessor&amp;     vertex_processor, </div><div class="line">      <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp;   renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>         pixel,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_masked_ray.html">MaskedRay</a>         ray,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector4f</a>   weight,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector2f</a>   cone,</div><div class="line">      <span class="keyword">const</span> uint32            nee_vertex_id);</div><div class="line"></div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> trace_shadow_ray(</div><div class="line">      TPTVertexProcessor&amp;     vertex_processor,</div><div class="line">      <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp;   renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>         pixel,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_masked_ray.html">MaskedRay</a>         ray,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>   weight,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>   weight_d,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>   weight_g,</div><div class="line">      <span class="keyword">const</span> uint32            nee_vertex_id,</div><div class="line">      <span class="keyword">const</span> uint32            nee_sample_id);</div><div class="line">};</div></div><!-- fragment --> Note that for the purpose of the <a class="el" href="group___p_t_lib_core.html">PTLibCore</a> module, a given implementation is free to define the trace methods in any arbitrary manner, since the result of tracing a ray is not used directly. This topic will be covered in more detail later on. <br />
<br />
<a class="anchor" id="TPTVertexProcessor"></a></li>
<li>a user defined vertex processor, determining what to do with each generated path vertex; this is the class responsible for weighting each sample and accumulating them to the image. It has to provide the following interface: <br />
<div class="fragment"><div class="line"><span class="keyword">struct </span>TPTVertexProcessor</div><div class="line">{</div><div class="line">  <span class="comment">// preprocess a vertex and return some packed vertex info - this is useful since this</span></div><div class="line">  <span class="comment">// information bit is automatically propagated through the entire path tracing pipeline,</span></div><div class="line">  <span class="comment">// and might be used, for example, to implement user defined caching strategies like</span></div><div class="line">  <span class="comment">// those employed in path space filtering, where the packed info would e.g. encode a</span></div><div class="line">  <span class="comment">// spatial hash.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// \param context               the current context</span></div><div class="line">  <span class="comment">// \param renderer              the current renderer</span></div><div class="line">  <span class="comment">// \param pixel_info            packed pixel info</span></div><div class="line">  <span class="comment">// \param ev                    the current vertex</span></div><div class="line">  <span class="comment">// \param cone_radius           the current cone radius</span></div><div class="line">  <span class="comment">// \param scene_bbox            the scene bounding box</span></div><div class="line">  <span class="comment">// \param prev_vertex_info      the vertex info at the previous path vertex</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  uint32 preprocess_vertex(</div><div class="line">      <span class="keyword">const</span> TPTContext&amp;           context,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp; renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>             pixel_info,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_eye_vertex.html">EyeVertex</a>&amp;            ev,</div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">float</span>                 cone_radius,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_bbox.html">cugar::Bbox3f</a>         scene_bbox,</div><div class="line">      <span class="keyword">const</span> uint32                prev_vertex_info);</div><div class="line"></div><div class="line">  <span class="comment">// compute NEE weights given a vertex and a light sample</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// \param context               the current context</span></div><div class="line">  <span class="comment">// \param renderer              the current renderer</span></div><div class="line">  <span class="comment">// \param pixel_info            packed pixel info</span></div><div class="line">  <span class="comment">// \param prev_vertex_info      packed vertex info at the previous path vertex</span></div><div class="line">  <span class="comment">// \param vertex_info           packed vertex info</span></div><div class="line">  <span class="comment">// \param ev                    the current vertex</span></div><div class="line">  <span class="comment">// \param f_d                   the diffuse brdf</span></div><div class="line">  <span class="comment">// \param f_g                   the glossy brdf</span></div><div class="line">  <span class="comment">// \param w                     the current path weight</span></div><div class="line">  <span class="comment">// \param f_L                   the current sample contribution, including the MIS weight</span></div><div class="line">  <span class="comment">// \param out_w_d               the output diffuse weight</span></div><div class="line">  <span class="comment">// \param out_w_g               the output glossy weight</span></div><div class="line">  <span class="comment">// \param out_vertex_info       the output packed vertex info</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> compute_nee_weights(</div><div class="line">      <span class="keyword">const</span> TPTContext&amp;           context,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp; renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>             pixel_info,</div><div class="line">      <span class="keyword">const</span> uint32                prev_vertex_info,</div><div class="line">      <span class="keyword">const</span> uint32                vertex_info,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_eye_vertex.html">EyeVertex</a>&amp;            ev,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      f_d,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      f_g,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      w,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      f_L,</div><div class="line">            <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      out_w_d,</div><div class="line">            <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      out_w_g,</div><div class="line">            uint32&amp;               out_vertex_info);</div><div class="line"></div><div class="line">  <span class="comment">// compute scattering weights given a vertex</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// \param context               the current context</span></div><div class="line">  <span class="comment">// \param renderer              the current renderer</span></div><div class="line">  <span class="comment">// \param pixel_info            packed pixel info</span></div><div class="line">  <span class="comment">// \param prev_vertex_info      packed vertex info at the previous path vertex</span></div><div class="line">  <span class="comment">// \param vertex_info           packed vertex info</span></div><div class="line">  <span class="comment">// \param ev                    the current vertex</span></div><div class="line">  <span class="comment">// \param out_comp              the brdf scattering component</span></div><div class="line">  <span class="comment">// \param g                     the brdf scattering weight (= f/p)</span></div><div class="line">  <span class="comment">// \param w                     the current path weight</span></div><div class="line">  <span class="comment">// \param out_w                 the output weight</span></div><div class="line">  <span class="comment">// \param out_vertex_info       the output vertex info</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> compute_scattering_weights(</div><div class="line">      <span class="keyword">const</span> TPTContext&amp;           context,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp; renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>             pixel_info,</div><div class="line">      <span class="keyword">const</span> uint32                prev_vertex_info,</div><div class="line">      <span class="keyword">const</span> uint32                vertex_info,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_eye_vertex.html">EyeVertex</a>&amp;            ev,</div><div class="line">      <span class="keyword">const</span> uint32                out_comp,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      g,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      w,</div><div class="line">            <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      out_w,</div><div class="line">            uint32&amp;               out_vertex_info);</div><div class="line"></div><div class="line">  <span class="comment">// accumulate an emissive surface hit</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// \param context               the current context</span></div><div class="line">  <span class="comment">// \param renderer              the current renderer</span></div><div class="line">  <span class="comment">// \param pixel_info            packed pixel info</span></div><div class="line">  <span class="comment">// \param prev_vertex_info      packed vertex info at the previous path vertex</span></div><div class="line">  <span class="comment">// \param vertex_info           packed vertex info</span></div><div class="line">  <span class="comment">// \param ev                    the current vertex</span></div><div class="line">  <span class="comment">// \param w                     the emissive sample weight</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> accumulate_emissive(</div><div class="line">      <span class="keyword">const</span> TPTContext&amp;           context,</div><div class="line">            <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp; renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>             pixel_info,</div><div class="line">      <span class="keyword">const</span> uint32                prev_vertex_info,</div><div class="line">      <span class="keyword">const</span> uint32                vertex_info,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_eye_vertex.html">EyeVertex</a>&amp;            ev,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      w);</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">// accumulate a NEE sample</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  <span class="comment">// \param context               the current context</span></div><div class="line">  <span class="comment">// \param renderer              the current renderer</span></div><div class="line">  <span class="comment">// \param pixel_info            packed pixel info</span></div><div class="line">  <span class="comment">// \param vertex_info           packed vertex info</span></div><div class="line">  <span class="comment">// \param hit                   the hit information</span></div><div class="line">  <span class="comment">// \param w_d                   the diffuse nee weight</span></div><div class="line">  <span class="comment">// \param w_g                   the glossy nee weight</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> accumulate_nee(</div><div class="line">      <span class="keyword">const</span> TPTContext&amp;           context,</div><div class="line">            <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp; renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>             pixel_info,</div><div class="line">      <span class="keyword">const</span> uint32                vertex_info,</div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">bool</span>                  shadow_hit,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      w_d,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>&amp;      w_g);</div><div class="line">};</div></div><!-- fragment --> <br />
<a class="anchor" id="TPTDirectLightingSampler"></a></li>
<li>a user defined direct lighting engine, responsible to generate NEE samples. It has to provide the following interface: <br />
<div class="fragment"><div class="line"><span class="keyword">struct </span>TDirectLightingSampler</div><div class="line">{</div><div class="line">  <span class="comment">// preprocess a path vertex and return a user defined hash integer key,</span></div><div class="line">  <span class="comment">// called &lt;i&gt;nee_vertex_id&lt;/i&gt;,</span></div><div class="line">  <span class="comment">// used for all subsequent NEE computations at this vertex;</span></div><div class="line">  <span class="comment">// this packed integer is useful to implement things like spatial hashing, where the current</span></div><div class="line">  <span class="comment">// vertex is hashed to a slot in a hash table, e.g. storing reinforcement-learning data.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  uint32 preprocess_vertex(</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp; renderer,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_eye_vertex.html">EyeVertex</a>&amp;    ev,</div><div class="line">      <span class="keyword">const</span> uint32        pixel,</div><div class="line">      <span class="keyword">const</span> uint32        bounce,</div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">bool</span>          is_secondary_diffuse,</div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">float</span>         cone_radius,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_bbox.html">cugar::Bbox3f</a> scene_bbox);</div><div class="line"></div><div class="line">  <span class="comment">// sample a light vertex at a given slot, and return a user defined sample index,</span></div><div class="line">  <span class="comment">// called &lt;i&gt;nee_sample_id&lt;/i&gt;: this integer may encode any arbitrary data the sampler</span></div><div class="line">  <span class="comment">// might need to later on address the generated sample in the update() method.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  uint32 sample(</div><div class="line">      <span class="keyword">const</span> uint32        nee_vertex_id,</div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">float</span>         z[3],</div><div class="line">      <a class="code" href="struct_vertex_geometry_id.html">VertexGeometryId</a>*   light_vertex,</div><div class="line">      <a class="code" href="struct_vertex_geometry.html">VertexGeometry</a>*     light_vertex_geom,</div><div class="line">      <span class="keywordtype">float</span>*              light_pdf,</div><div class="line">      <a class="code" href="struct_edf.html">Edf</a>*                light_edf);</div><div class="line"></div><div class="line">  <span class="comment">// map a light vertex defined by its triangle id and uv barycentric coordinates to the</span></div><div class="line">  <span class="comment">// corresponding differential geometry, computing its EDF and sampling PDF, using the</span></div><div class="line">  <span class="comment">// slot information computed at the previous vertex along the path; this method is called</span></div><div class="line">  <span class="comment">// on emissive surface hits to figure out the PDF with which the hits would have been</span></div><div class="line">  <span class="comment">// generated by NEE.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> map(</div><div class="line">      <span class="keyword">const</span> uint32            prev_nee_vertex_id,</div><div class="line">      <span class="keyword">const</span> uint32            triId,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector2f</a>   uv,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="struct_vertex_geometry.html">VertexGeometry</a>    light_vertex_geom,</div><div class="line">      <span class="keywordtype">float</span>*                  light_pdf,</div><div class="line">      <a class="code" href="struct_edf.html">Edf</a>*                    light_edf);</div><div class="line"></div><div class="line">  <span class="comment">// update the internal state of the sampler with the resulting NEE sample</span></div><div class="line">  <span class="comment">// information, useful to e.g. implement reinforcement-learning strategies.</span></div><div class="line">  <span class="comment">//</span></div><div class="line">  FERMAT_DEVICE</div><div class="line">  <span class="keywordtype">void</span> update(</div><div class="line">      <span class="keyword">const</span> uint32            nee_vertex_id,</div><div class="line">      <span class="keyword">const</span> uint32            nee_sample_id,</div><div class="line">      <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>   w,</div><div class="line">      <span class="keyword">const</span> <span class="keywordtype">bool</span>              occluded);</div><div class="line">};</div></div><!-- fragment --> </li>
</ol>
</dd></dl>
<dl class="section user"><dt></dt><dd>You'll notice this is just a slight generalization of the <a class="el" href="struct_light.html">Light</a> interface, providing more controls for preprocessing and updating some per-vertex information. At the moment, Fermat provides two different implementations of this interface: <br />
<ul>
<li><a class="el" href="struct_direct_lighting_mesh.html">DirectLightingMesh</a> : a simple wrapper around the <a class="el" href="struct_mesh_light.html">MeshLight</a> class;</li>
<li><a class="el" href="struct_direct_lighting_r_l.html">DirectLightingRL</a> : a more advanced sampler based on <a href="https://en.wikipedia.org/wiki/Reinforcement_learning">Reinforcement Learning</a>.</li>
</ul>
</dd></dl>
<dl class="section user"><dt></dt><dd>The most important functions implemented by the <a class="el" href="group___p_t_lib_core.html">PTLibCore</a> module are: <br />
<div class="fragment"><div class="line"><span class="comment">// generate a primary ray based on the given pixel index</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \tparam TPTContext             A path tracing context</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \param context                  the path tracing context</span></div><div class="line"><span class="comment">// \param renderer                 the rendering context</span></div><div class="line"><span class="comment">// \param pixel                    the unpacked 2d pixel index</span></div><div class="line"><span class="comment">// \param U                        the horizontal (+X) camera frame vector</span></div><div class="line"><span class="comment">// \param V                        the vertical (+Y) camera frame vector</span></div><div class="line"><span class="comment">// \param W                        the depth (+Z) camera frame vector</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TPTContext&gt;</div><div class="line">FERMAT_DEVICE</div><div class="line"><a class="code" href="struct_masked_ray.html">MaskedRay</a> <a class="code" href="group___p_t_lib_core.html#ga28fe33ab0663b2331fe607662ed07349">generate_primary_ray</a>(</div><div class="line">  TPTContext&amp;             context,</div><div class="line">  <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp;   renderer,</div><div class="line">  <span class="keyword">const</span> uint2             pixel,</div><div class="line">  <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>         U,</div><div class="line">  <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>         V,</div><div class="line">  <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>         W);</div><div class="line"></div><div class="line"><span class="comment">// processes a NEE sample, using already computed occlusion information</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \tparam TPTContext         A path tracing context, which must adhere to the TPTContext interface</span></div><div class="line"><span class="comment">// \tparam TPTVertexProcessor A vertex processor, which must adhere to the TPTVertexProcessor interface</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \param context                  the path tracing context</span></div><div class="line"><span class="comment">// \param vertex_processor         the vertex processor</span></div><div class="line"><span class="comment">// \param renderer                 the rendering context</span></div><div class="line"><span class="comment">// \param shadow_hit               a bit indicating whether the sample is occluded or not</span></div><div class="line"><span class="comment">// \param pixel_info               the packed pixel info</span></div><div class="line"><span class="comment">// \param w                        the total sample weight</span></div><div class="line"><span class="comment">// \param w_d                      the diffuse sample weight</span></div><div class="line"><span class="comment">// \param w_g                      the glossy sample weight</span></div><div class="line"><span class="comment">// \param vertex_info              the current vertex info produced by the vertex processor</span></div><div class="line"><span class="comment">// \param nee_vertex_id            the current NEE slot computed by the direct lighting sampler</span></div><div class="line"><span class="comment">// \param nee_sample_id            the current NEE sample info computed by the direct lighting sampler</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TPTContext, <span class="keyword">typename</span> TPTVertexProcessor&gt;</div><div class="line">FERMAT_DEVICE</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___b_p_t_lib_core.html#ga588188b86e2afbe1f62d1bdd7a145cbf">solve_occlusion</a>(</div><div class="line">  TPTContext&amp;             context,</div><div class="line">  TPTVertexProcessor&amp;     vertex_processor,</div><div class="line">  <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp;   renderer,</div><div class="line">  <span class="keyword">const</span> <span class="keywordtype">bool</span>              shadow_hit,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>         pixel_info,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>   w,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>   w_d,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector3f</a>   w_g</div><div class="line">  <span class="keyword">const</span> uint32            vertex_info    = uint32(-1),</div><div class="line">  <span class="keyword">const</span> uint32            nee_vertex_id  = uint32(-1),</div><div class="line">  <span class="keyword">const</span> uint32            nee_sample_id  = uint32(-1));</div><div class="line"></div><div class="line"><span class="comment">// processes a path vertex, performing these three key steps:</span></div><div class="line"><span class="comment">// - sampling NEE</span></div><div class="line"><span class="comment">// - accumulating emissive surface hits</span></div><div class="line"><span class="comment">// - scattering</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \tparam TPTContext         A path tracing context, which must adhere to the TPTContext interface</span></div><div class="line"><span class="comment">// \tparam TPTVertexProcessor A vertex processor, which must adhere to the TPTVertexProcessor interface</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \param context                  the path tracing context</span></div><div class="line"><span class="comment">// \param vertex_processor         the vertex processor</span></div><div class="line"><span class="comment">// \param renderer                 the rendering context</span></div><div class="line"><span class="comment">// \param pixel_info               the packed pixel info</span></div><div class="line"><span class="comment">// \param pixel                    the unpacked 2d pixel index</span></div><div class="line"><span class="comment">// \param ray                      the incoming ray</span></div><div class="line"><span class="comment">// \param hit                      the hit information</span></div><div class="line"><span class="comment">// \param w                        the current path weight</span></div><div class="line"><span class="comment">// \param prev_vertex_info         the vertex info produced by the vertex processor at the previous vertex</span></div><div class="line"><span class="comment">// \param prev_nee_vertex_id       the NEE slot corresponding to the previous vertex</span></div><div class="line"><span class="comment">// \param cone                     the incoming ray cone</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TPTContext, <span class="keyword">typename</span> TPTVertexProcessor&gt;</div><div class="line">FERMAT_DEVICE</div><div class="line"><span class="keywordtype">bool</span> <a class="code" href="group___p_t_lib_core.html#ga9b8be237ade285e6db792a9ea7bf900e">shade_vertex</a>(</div><div class="line">  TPTContext&amp;             context,</div><div class="line">  TPTVertexProcessor&amp;     vertex_processor,</div><div class="line">  <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp;   renderer,</div><div class="line">  <span class="keyword">const</span> uint32            bounce,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="union_pixel_info.html">PixelInfo</a>         pixel_info,</div><div class="line">  <span class="keyword">const</span> uint2             pixel,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="struct_masked_ray.html">MaskedRay</a>&amp;        ray,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="struct_hit.html">Hit</a>               hit,</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector4f</a>   w,</div><div class="line">  <span class="keyword">const</span> uint32            prev_vertex_info = uint32(-1),</div><div class="line">  <span class="keyword">const</span> uint32            prev_nee_vertex_id    = uint32(-1),</div><div class="line">  <span class="keyword">const</span> <a class="code" href="structcugar_1_1_vector.html">cugar::Vector2f</a>   cone             = <a class="code" href="structcugar_1_1_vector.html">cugar::Vector2f</a>(0));</div></div><!-- fragment --> </dd></dl>
<dl class="section user"><dt></dt><dd>Note that all of these are device-side functions meant to be called by individual CUDA threads. The underlying idea is that all of them might call into <a class="el" href="_p_t_lib_page.html#TPTContext">TPTContext</a> trace() methods, but that the implementation of the <a class="el" href="_p_t_lib_page.html#TPTContext">TPTContext</a> class might decide whether to perform the trace calls in-place, or rather enqueue them. The latter approach is called "wavefront" scheduling, and is the one favored in Fermat, as so far it has proven most efficient.</dd></dl>
<h1><a class="anchor" id="PTWavefrontSchedulingSection"></a>
Wavefront Scheduling</h1>
<dl class="section user"><dt></dt><dd><a class="el" href="group___p_t_lib.html">PTLib</a> implements a series of kernels to execute all of the above functions in massively parallel waves, assuming their inputs can be fetched from some <a class="el" href="_p_t_lib_page.html#TPTContext">TPTContext</a> -defined queues. In order for these wavefronts kernels to work, it is sufficient to have the <a class="el" href="_p_t_lib_page.html#TPTContext">TPTContext</a> implementation inherit from the prepackaged <a class="el" href="struct_p_t_context_queues.html">PTContextQueues</a> class, containing all necessary queue storage. Together with the kernels themselves, the corresponding host dispatch functions are provided as well. These are the following:</dd></dl>
<div class="fragment"><div class="line"><span class="comment">// dispatch the kernel to generate primary rays: the number of rays is defined by the resolution</span></div><div class="line"><span class="comment">// parameters provided by the rendering context.</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \tparam TPTContext           A path tracing context</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \param context               the path tracing context</span></div><div class="line"><span class="comment">// \param renderer              the rendering context</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TPTContext&gt;</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_t_lib.html#ga66602a846711dc021ed0b930846ea596">generate_primary_rays</a>(</div><div class="line">    TPTContext              context,</div><div class="line">    <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>    renderer);</div><div class="line"></div><div class="line"><span class="comment">// dispatch the shade hits kernel</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \tparam TPTContext           A path tracing context, which must adhere to the TPTContext interface</span></div><div class="line"><span class="comment">// \tparam TPTVertexProcessor   A vertex processor, which must adhere to the TPTVertexProcessor interface</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \param in_queue_size         the size of the input queue containing all path vertices in the current wave</span></div><div class="line"><span class="comment">// \param context               the path tracing context</span></div><div class="line"><span class="comment">// \param vertex_processor      the vertex_processor</span></div><div class="line"><span class="comment">// \param renderer              the rendering context</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TPTContext, <span class="keyword">typename</span> TPTVertexProcessor&gt;</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_t_lib.html#ga303934170f8bdcf0d8c674d7bc2f2513">shade_hits</a>(</div><div class="line">    <span class="keyword">const</span> uint32            in_queue_size,</div><div class="line">    TPTContext              context,</div><div class="line">    TPTVertexProcessor      vertex_processor,</div><div class="line">    <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>    renderer);</div><div class="line"></div><div class="line"><span class="comment">// dispatch a kernel to process NEE samples using computed occlusion information</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \tparam TPTContext           A path tracing context, which must adhere to the TPTContext interface</span></div><div class="line"><span class="comment">// \tparam TPTVertexProcessor   A vertex processor, which must adhere to the TPTVertexProcessor interface</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// \param in_queue_size         the size of the input queue containing all processed NEE samples</span></div><div class="line"><span class="comment">// \param context               the path tracing context</span></div><div class="line"><span class="comment">// \param vertex_processor      the vertex_processor</span></div><div class="line"><span class="comment">// \param renderer              the rendering context</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TPTContext, <span class="keyword">typename</span> TPTVertexProcessor&gt;</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___b_p_t_lib_core.html#ga588188b86e2afbe1f62d1bdd7a145cbf">solve_occlusion</a>(</div><div class="line">    <span class="keyword">const</span> uint32            in_queue_size,</div><div class="line">    TPTContext              context,</div><div class="line">    TPTVertexProcessor      vertex_processor,</div><div class="line">    <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>    renderer);</div></div><!-- fragment --><p> <a class="anchor" id="path_trace_loop_anchor"></a></p><dl class="section user"><dt></dt><dd>The last key function provided by this module is the one assembling all of the above into a single loop, or rather, into a complete pipeline that generates primary rays, traces them, shades the resulting vertices, traces any generated shadow and scattering rays, shades the results, and so, and so on, until all generated paths are terminated:</dd></dl>
<div class="fragment"><div class="line"><span class="comment">// main path tracing loop</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TPTContext, <span class="keyword">typename</span> TPTVertexProcessor&gt;</div><div class="line"><span class="keywordtype">void</span> <a class="code" href="group___p_t_lib.html#gadbd6e824e2ecdd07fae235bddebcd1d8">path_trace_loop</a>(</div><div class="line">    TPTContext&amp;             context,</div><div class="line">    TPTVertexProcessor&amp;     vertex_processor,</div><div class="line">    <a class="code" href="struct_rendering_context.html">RenderingContext</a>&amp;       renderer,</div><div class="line">    <a class="code" href="struct_rendering_context_view.html">RenderingContextView</a>&amp;   renderer_view,</div><div class="line">    <a class="code" href="struct_p_t_loop_stats.html">PTLoopStats</a>&amp;            stats);</div></div><!-- fragment --><dl class="section user"><dt></dt><dd>In the next chapter we'll see how all of this can be used to write a very compact path tracer.</dd></dl>
<div class="image">
<img src="staircase2-sunset.jpg" style="position:relative; bottom:-10px; border:0px; width:740px;"/>
</div>
 <dl class="section user"><dt></dt><dd><small>'Modern Hall, at sunset', based on a <a href="http://www.blendswap.com/blends/view/51997">model</a> by <em>NewSee2l035</em></small> <br />
</dd></dl>
<p>Next: <a class="el" href="_p_t_page.html">The Path Tracer (Revisited)</a> </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
